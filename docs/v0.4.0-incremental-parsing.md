# ğŸ“˜ v0.4.0 Development Document: Streaming/Incremental Parsing

> **Status**: âœ… Completed  
> **Estimated Time**: 2-3 weeks  
> **Dependencies**: v0.2.0 recommended  
> **Priority**: â­â­â­ Highest (User's top request)

---

## 1. Overview

### 1.1 Goal
Enable field extraction as they complete during LLM streaming, allowing early processing (TTS, UI updates).

### 1.2 Core Value

```
Traditional approach:
LLM streaming start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Complete â†’ Parse â†’ Start TTS
                                                            â”‚
                                                            â–¼
                                                      Total latency

IncrementalLoot:
LLM streaming start â”€â”€â–º dialogue complete â†’ Start TTS â”€â”€â–º Complete
                              â”‚                              â”‚
                              â–¼                              â–¼
                        Early TTS start              Significantly reduced latency
```

### 1.3 Scope of Changes
| File | Change Type |
|------|-------------|
| `src/incremental/index.ts` | New file |
| `src/incremental/IncrementalLoot.ts` | New file |
| `src/incremental/FieldTracker.ts` | New file |
| `src/incremental/types.ts` | New file |
| `src/index.ts` | Modified (export additions) |

---

## 2. API Design

### 2.1 Class Signature

```typescript
class IncrementalLoot<T = unknown> {
  constructor(options?: IncrementalLootOptions);
  addChunk(chunk: string): IncrementalResult<T>;
  getResult(): T | null;
  reset(): void;
}
```

### 2.2 Options

```typescript
interface IncrementalLootOptions {
  fields?: string[];
  repair?: boolean;
  onFieldComplete?: (field: string, value: unknown) => void;
  onComplete?: (result: unknown) => void;
  onError?: (error: Error) => void;
}
```

### 2.3 Result Interface

```typescript
interface IncrementalResult<T> {
  isComplete(): boolean;
  isFieldComplete(field: string): boolean;
  getField<F = unknown>(field: string): F | undefined;
  getPartialResult(): Partial<T>;
  getCompletedFields(): string[];
  getBuffer(): string;
}
```

### 2.4 Usage Example

```typescript
import { IncrementalLoot } from 'loot-json';

const parser = new IncrementalLoot<ChatResponse>({
  fields: ['dialogue', 'emotion'],
  onFieldComplete: (field, value) => {
    if (field === 'dialogue') {
      startTTS(value as string); // Start TTS immediately!
    }
  },
});

for await (const chunk of llmStream) {
  const result = parser.addChunk(chunk);
  
  if (result.isComplete()) {
    break;
  }
}

const finalResult = parser.getResult();
```

---

## 3. Architecture

### 3.1 Class Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     IncrementalLoot<T>                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - buffer: string                                            â”‚
â”‚ - fieldTracker: FieldTracker                                â”‚
â”‚ - options: IncrementalLootOptions                           â”‚
â”‚ - state: ParserState                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + addChunk(chunk: string): IncrementalResult<T>             â”‚
â”‚ + getResult(): T | null                                     â”‚
â”‚ + reset(): void                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ uses
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FieldTracker                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - trackedFields: Set<string>                                â”‚
â”‚ - completedFields: Map<string, unknown>                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + isTracking(field: string): boolean                        â”‚
â”‚ + completeField(field: string, value: unknown): void        â”‚
â”‚ + isComplete(field: string): boolean                        â”‚
â”‚ + getField(field: string): unknown                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   INITIAL   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ { detected
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”Œâ”€â”€â”€â”€â”€â”€â”‚  IN_OBJECT  â”‚â—„â”€â”€â”€â”€â”€â”
             â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚
             â”‚             â”‚             â”‚
    " found  â”‚             â”‚ " found     â”‚ , or nested
             â”‚             â–¼             â”‚
             â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
             â”‚      â”‚   IN_KEY    â”‚â”€â”€â”€â”€â”€â”€â”¤
             â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚
             â”‚             â”‚ : found     â”‚
             â”‚             â–¼             â”‚
             â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
             â””â”€â”€â”€â”€â”€â–ºâ”‚  IN_VALUE   â”‚â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ } at depth 0
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  COMPLETE   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Field Completion Detection

| Field Type | Completion Condition |
|------------|---------------------|
| String | Closing `"` detected (excluding escapes) |
| Number | `,` or `}` or `]` detected |
| Boolean/null | Complete token detected |
| Object | `}` detected + depth 0 |
| Array | `]` detected + depth 0 |

---

## 5. Test Cases

```typescript
describe('IncrementalLoot', () => {
  it('should detect string field completion', () => {
    const parser = new IncrementalLoot({ fields: ['dialogue'] });
    
    let result = parser.addChunk('{"dialogue": "Hel');
    expect(result.isFieldComplete('dialogue')).toBe(false);
    
    result = parser.addChunk('lo!", "other": 1}');
    expect(result.isFieldComplete('dialogue')).toBe(true);
    expect(result.getField('dialogue')).toBe('Hello!');
  });

  it('should call onFieldComplete callback', () => {
    const onFieldComplete = vi.fn();
    const parser = new IncrementalLoot({
      fields: ['dialogue'],
      onFieldComplete,
    });

    parser.addChunk('{"dialogue": "Hello!"}');
    expect(onFieldComplete).toHaveBeenCalledWith('dialogue', 'Hello!');
  });
});
```

---

## 6. Technical Challenges

| Challenge | Solution |
|-----------|----------|
| Special chars in strings (`\"`, `\\`) | Escape sequence state tracking |
| Nested objects/arrays | Depth counter |
| Incomplete chunks | Buffering + partial parsing |
| Memory efficiency | Parse completed fields immediately |

---

## 7. Notes

### 7.1 Known Limitations
- Top-level arrays not supported (objects only)
- Nested field path tracking considered for v1.0.0

### 7.2 Future Improvements
- Per-array-element streaming
- Nested field tracking (`user.profile.name`)
- Memory optimization (buffer trimming)

### 7.3 Compatibility
- Node.js >= 16.0.0
- Browser ES2020+
