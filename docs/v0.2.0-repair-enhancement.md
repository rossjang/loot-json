# ðŸ“˜ v0.2.0 Development Document: Repair Enhancement

> **Status**: âœ… Completed  
> **Estimated Time**: 1 week  
> **Dependencies**: None (independent work)

---

## 1. Overview

### 1.1 Goals
- Add multiline string repair functionality
- Add repair report functionality

### 1.2 Background
LLMs frequently generate unescaped newlines within JSON strings. Additionally, users need visibility into what repairs were applied for debugging purposes.

### 1.3 Scope of Changes
| File | Change Type |
|------|-------------|
| `src/repairs.ts` | Modified (function additions) |
| `src/types.ts` | Modified (type additions) |
| `src/loot.ts` | Modified (option handling) |
| `src/index.ts` | Modified (export additions) |

---

## 2. Feature 1: Multiline String Repair

### 2.1 Problem

```json
// Invalid JSON generated by LLM
{
  "dialogue": "Hello,
  how are you today?
  I hope you're doing well."
}
```

The above JSON fails to parse due to unescaped newlines (`\n`) within the string.

### 2.2 Solution

```json
// Repaired JSON
{
  "dialogue": "Hello,\n  how are you today?\n  I hope you're doing well."
}
```

### 2.3 Implementation

The `fixUnescapedNewlines` function was added to `repairs.ts`:
- Tracks whether currently inside a string literal
- Converts raw newlines to escaped `\n` sequences within strings
- Preserves newlines outside strings (JSON formatting)

---

## 3. Feature 2: Repair Report

### 3.1 Goal
Provide detailed information about what repairs were applied for debugging.

### 3.2 API

```typescript
interface RepairLog {
  type: RepairType;
  position?: number;
  description: string;
  fixed: boolean;
}

// Usage
const { result, repairs } = loot(text, { reportRepairs: true });
console.log(repairs);
// [
//   { type: 'trailing_comma', position: 45, description: '...', fixed: true },
//   { type: 'single_line_comment', position: 30, description: '...', fixed: true },
// ]
```

### 3.3 Repair Types

| Type | Description |
|------|-------------|
| `trailing_comma` | Removed trailing comma |
| `single_quote` | Replaced single quotes with double quotes |
| `single_line_comment` | Removed `//` comment |
| `multi_line_comment` | Removed `/* */` comment |
| `unquoted_key` | Quoted unquoted property key |
| `invalid_value` | Replaced undefined/NaN/Infinity with null |
| `unescaped_newline` | Escaped newline in string |

---

## 4. Test Cases

```typescript
describe('repairJson with tracking', () => {
  it('should return repairs when tracking is enabled', () => {
    const result = repairJson('{"key": "value",}', true);
    expect(result.text).toBe('{"key": "value"}');
    expect(result.repairs.some(r => r.type === 'trailing_comma')).toBe(true);
  });

  it('should track multiple repairs', () => {
    const result = repairJson("{key: 'value', // comment\n}", true);
    expect(result.repairs.some(r => r.type === 'unquoted_key')).toBe(true);
    expect(result.repairs.some(r => r.type === 'single_quote')).toBe(true);
    expect(result.repairs.some(r => r.type === 'single_line_comment')).toBe(true);
  });
});
```

---

## 5. Notes

### 5.1 Backward Compatibility
- Existing API unchanged
- Default value of `reportRepairs` is `false`
- No impact on existing user code

### 5.2 Performance
- When `trackRepairs = false`, minimal additional overhead
- Report generation is opt-in
